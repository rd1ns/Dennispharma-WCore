@model string
@using WCore.Web.Areas.Admin.Helpers
@using WCore.Core
@using WCore.Services.Security
@using WCore.Framework.UI
@using WCore.Core.Domain 
@using WCore.Framework.Themes 
@{

    var metaDatas = ViewData.ModelMetadata.Properties;

    var modelBody = Html.IdForModel();

    var formNameValue = "";

    var htmlAttributes = ViewData["htmlAttributes"];
    if (htmlAttributes != null)
    {
        var metaValue = (Dictionary<string, object>)ViewData["htmlAttributes"];
        var formName = metaValue.FirstOrDefault(o => o.Key == "form-name").Value;
        if (formName != null)
        {
            formNameValue = "#" + formName.ToString() + " ";
        }
    }

    //we do not bundle this script file (does not work for some reasons in bundle)
    Html.AddScriptParts("~/editor/tinymce/tinymce.min.js", excludeFromBundle: true);

    // tinyMCE language
    var language = TinyMceHelper.GetTinyMceLanguage();

    var allowRoxyFileman = true;

    var random = CommonHelper.GenerateRandomInteger();

    //extend editor with additional settings
    //Sample setting value (below):
    //settings.plugins.push('print'); settings.toolbar += ' | print';
    var additionalEditorSettings = true.ToString().ToLower();
    //is java-script supported?
    var allowJavaScript = true.ToString().ToLower();

    //allow HTML body? Full page? - http://www.tinymce.com/wiki.php/Plugin:fullpage
    //false by default
    var enableFullPage = Convert.ToBoolean(ViewData["WCore.RichEditor.EnableFullPage"] ?? false);

    var extended_valid_elements = new List<string>();
    var valid_children = new List<string>();

    if (allowJavaScript.ToBool())
    {
        extended_valid_elements.Add("script[charset|defer|language|src|type]");
        valid_children.Add("+body[script]");
    }
    extended_valid_elements.Add("style[dir<ltr?rtl|lang|media|title|type]");
    extended_valid_elements.Add("link[dir<ltr?rtl|href|hreflang|lang|media|rel|rev|title|target|type]");

    valid_children.Add("+body[style]");
    valid_children.Add("+body[link]");

    var _themeContext = EngineContext.Current.Resolve<IThemeContext>();
    var _storeInformationSettings = EngineContext.Current.Resolve<StoreInformationSettings>();
}

<script>
        $(document).ready(function () {
         @* wooncherk contribution *@
         function RoxyFileBrowser@(random)(field_name, url, type, win) {
            //we manually generate the configuration file to ensure that it works fine in virtual directory
            $.ajax({
                cache: false,
                type: "GET",
                url: "/admin/roxyfileman/CreateConfiguration",
                success: function (data, textStatus, jqXHR) {
                    var roxyFileman = '@Url.Content("~/editor/Roxy_Fileman/index.html")';
                    if (roxyFileman.indexOf("?") < 0) {
                        roxyFileman += "?type=" + type;
                    } else {
                        roxyFileman += "&type=" + type;
                    }
                    roxyFileman += '&input=' + field_name + '&value=' + document.getElementById(field_name).value;
                    tinyMCE.activeEditor.windowManager.open({
                        file: roxyFileman,
                        title: 'Roxy Fileman',
                        width: 850,
                        height: 900,
                        resizable: "yes",
                        plugins: "media",
                        inline: "yes",
                        close_previous: "no"
                    }, { window: win, input: field_name });
                    return false;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $('#createConfigurationFailed-info').text(errorThrown);
                    $("#createConfigurationFailed").click();
                }
            });
        }

         var defaultEditorSettings@(random) = {
            selector: "#@random",
            fontsize_formats: "8pt 9pt 10pt 11pt 12pt 26pt 36pt",
            height: 1080,
            width: '100%',
            autoresize_min_height: 200,
            autoresize_max_height: 1080,
            forced_root_block: "",
            force_br_newlines: true,
            force_p_newlines: false,
            plugins: [
                "codemirror advlist autolink autoresize directionality lists link image charmap preview anchor",
                "searchreplace visualblocks fullscreen textcolor",
                "insertdatetime media table contextmenu paste@(enableFullPage ? " fullpage" : null) "
            ],
            toolbar: "code | ltr rtl | insertfile undo redo | styleselect | fontselect | fontsizeselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist utdent indent | link image ",
            codemirror: {
                path: 'codemirror-4.8',
                width: 1200,
                height: 600,
                jsFiles: [
                    'mode/clike/clike.js',
                    'mode/php/php.js'
                ]
             },
             cleanup : false,
             relative_urls: false,
             verify_html : false,
             content_css: "/@_themeContext.WorkingThemeName/css/plugins-css.css,"+
                          "/@_themeContext.WorkingThemeName/revolution/css/settings.css," +
                          "/@_themeContext.WorkingThemeName/css/typography.css," +
                          "/@_themeContext.WorkingThemeName/css/shortcodes/shortcodes.css," +
                          "/@_themeContext.WorkingThemeName/css/style.css," +
                          "/@_themeContext.WorkingThemeName/css/responsive.css,"+
                          "/@_themeContext.WorkingThemeName/css/sizes.css,"+
                          @if (!string.IsNullOrEmpty(_storeInformationSettings.DefaultStoreThemeColorScheme)){
                              <text>"/@_themeContext.WorkingThemeName/css/skins/@(_storeInformationSettings.DefaultStoreThemeColorScheme+".css")",</text>
                          }
            @if (allowRoxyFileman)
            {
                <text>
                    //picture manager
                    file_browser_callback: RoxyFileBrowser@(random),
                </text>
            }
            @if (!string.IsNullOrEmpty(language))
            {
                <text>
                    //language
                    language: "@language",
                </text>
            }
            convert_urls: false,
            entity_encoding: "raw",
            @if (allowJavaScript.ToBool())
            {
                <text>
                    allow_script_urls: true,
                </text>
            }
            else
            {
                <text>
                    invalid_elements: "script",
                </text>
            }
            @if (extended_valid_elements.Any())
            {
                <text>
                    extended_valid_elements: "@Html.Raw(string.Join(',', extended_valid_elements))",
                </text>
            }
            @if (valid_children.Any())
            {
                <text>
                    valid_children: "@Html.Raw(string.Join(',', valid_children))"
                </text>
            }
        };

         function getAdditionalEditorSettings@(random)(settings) {
            @Html.Raw(additionalEditorSettings)
            return settings;
        }
            tinyMCE.init(getAdditionalEditorSettings@(random)(defaultEditorSettings@(random)));
        });
</script>


<textarea id="@random" asp-for="@Model" data-form-name="@formNameValue">@ViewData.TemplateInfo.FormattedModelValue</textarea>
